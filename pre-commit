#!/bin/sh

exec bash -c '
# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ pre-commit hook —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π
ENABLED=$(git config --get gitleaks.precommit.enabled)

if [ "$ENABLED" != "true" ]; then
    echo "‚öôÔ∏è  Gitleaks pre-commit hook –≤–∏–º–∫–Ω–µ–Ω–∏–π (git config gitleaks.precommit.enabled)."
    exit 0
fi

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—è –¥–ª—è Linux/macOS
if ! command -v gitleaks &> /dev/null; then
    echo "Ì¥ç Gitleaks –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í–∏–∫–æ–Ω—É—é —ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—é..."
    bash scripts/install_gitleaks.sh
fi

echo "Ì¥í –ó–∞–ø—É—Å–∫–∞—é gitleaks –ø–µ—Ä–µ–≤—ñ—Ä–∫—É..."

# –î–ª—è Windows
if [ -f "./gitleaks.exe" ]; then
    ./gitleaks.exe detect --source . --no-git --report-format json --report-path gitleaks-report.json
else
    gitleaks detect --source . --no-git --report-format json --report-path gitleaks-report.json
fi

if [ $? -ne 0 ]; then
    echo "‚ùå Gitleaks –≤–∏—è–≤–∏–≤ —Å–µ–∫—Ä–µ—Ç–∏ –≤ –∑–∞–∫–æ–º—ñ—á–µ–Ω–∏—Ö —Ñ–∞–π–ª–∞—Ö! –ö–æ–º—ñ—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ."
    cat gitleaks-report.json
    exit 1
else
    echo "‚úÖ –ù—ñ—è–∫–∏—Ö —Å–µ–∫—Ä–µ—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ö–æ–º—ñ—Ç –¥–æ–∑–≤–æ–ª–µ–Ω–æ."
    exit 0
fi
'
